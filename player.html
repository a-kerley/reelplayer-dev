<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reel Player</title>
  
  <!-- ============================================
       CSS IMPORTS - Single Source of Truth
       All styles imported from actual CSS files
       ============================================ -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/player.css">
  <link rel="stylesheet" href="css/playlist.css">
  <link rel="stylesheet" href="css/expandable.css">
  
  <style>
    /* ============================================
       IFRAME-SPECIFIC STYLES
       Minimal overrides for embed context
       ============================================ */
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      height: 100%;
    }
    
    #embedPlayer {
      width: 100%;
      min-height: 300px;
      height: 100%;
      position: relative;
      box-sizing: border-box;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .error-message {
      color: #dc3545;
      text-align: center;
      padding: 2rem;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 1rem;
    }
    
    .loading-message {
      color: #6c757d;
      text-align: center;
      padding: 2rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="embedPlayer">
    <div class="loading-message">Loading player...</div>
  </div>

  <!-- WaveSurfer.js - Audio waveform library -->
  <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7"></script>
  
  <script type="module">
    /* ============================================
       REEL PLAYER EMBED
       Loads and initializes player from stored reel data
       References player.js module for all functionality
       ============================================ */
    
    // Import actual player module and utilities
    import { playerApp } from './js/player.js';
    import { getColorFilters } from './js/modules/colorUtils.js';
    
    // ============================================
    // INITIALIZATION
    // ============================================
    
    // Get reel ID from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const reelId = urlParams.get('id');
    
    if (!reelId) {
      showError('No reel ID provided');
    } else {
      loadAndRenderReel(reelId);
    }
    
    /* ============================================
       MAIN LOADING FUNCTION
       ============================================ */
    async function loadAndRenderReel(reelId) {
      try {
        // Retrieve reel data from localStorage
        const reelData = await loadReelData(reelId);
        
        if (!reelData) {
          showError('Reel not found');
          return;
        }
        
        // Validate reel has tracks
        if (!reelData.playlist || reelData.playlist.length === 0) {
          showError('No tracks found in reel');
          return;
        }
        
        // Apply custom CSS variables from reel settings
        applyReelStyles(reelData);
        
        // Render player HTML using same structure as main player
        renderPlayerHTML(reelData);
        
        // Initialize player using actual playerApp module
        initializeEmbedPlayer(reelData);
        
      } catch (error) {
        console.error('Failed to load reel:', error);
        showError('Failed to load reel');
      }
    }
    
    /* ============================================
       REEL DATA LOADING
       Loads from localStorage with parent fallback
       ============================================ */
    async function loadReelData(reelId) {
      // Try local storage first
      const storedData = localStorage.getItem(`reel_${reelId}`);
      if (storedData) {
        console.log('✓ Loaded reel from local storage');
        return JSON.parse(storedData);
      }
      
      // Try parent window if in iframe (cross-origin safe)
      try {
        if (window.parent && window.parent !== window) {
          const parentData = window.parent.localStorage.getItem(`reel_${reelId}`);
          if (parentData) {
            console.log('✓ Loaded reel from parent window storage');
            return JSON.parse(parentData);
          }
        }
      } catch (e) {
        console.log('Cannot access parent localStorage (cross-origin)');
      }
      
      return null;
    }
    
    /* ============================================
       ERROR DISPLAY
       ============================================ */
    function showError(message) {
      document.getElementById('embedPlayer').innerHTML = 
        `<div class="error-message">❌ ${message}</div>`;
    }
    
    /* ============================================
       APPLY REEL STYLES
       Sets CSS variables and container styles
       Matches PreviewManager behavior exactly
       ============================================ */
    function applyReelStyles(reelData) {
      const settings = reelData.settings || {};
      const ta = settings.titleAppearance || {};
      
      // Process padding
      let paddingBottom = ta.paddingBottom || "1.5rem";
      if (typeof paddingBottom === "string" && !paddingBottom.match(/[a-z%]+$/)) {
        paddingBottom = paddingBottom + "px";
      }
      
      // Process background configuration
      // NEW IMPLEMENTATION (matches PreviewManager exactly):
      // - backgroundColor is ALWAYS the base solid color behind everything
      // - overlayColor is ALWAYS applied to ::before pseudo-element (with blur)
      // - backgroundImage is only included if enabled
      
      const backgroundImage = (settings.backgroundImageEnabled && settings.backgroundImage && settings.backgroundImage.trim()) 
        ? settings.backgroundImage 
        : null;
      
      // backgroundColor is ALWAYS the base solid color
      const backgroundColor = reelData.backgroundColor || settings.backgroundColor || "rgba(255, 255, 255, 1)";
      
      // overlayColor is ALWAYS applied to ::before (transparent by default)
      let overlayColor = "rgba(255, 255, 255, 0)";
      if (settings.overlayColorEnabled && settings.overlayColor) {
        overlayColor = settings.overlayColor;
      }
      
      const uiAccentColor = settings.varUiAccent || '#2a0026';
      
      // Calculate Lottie color filters for loading animation
      const colorFilters = getColorFilters(uiAccentColor);
      
      // ============================================
      // Apply CSS variables to document root
      // ============================================
      const root = document.documentElement;
      
      // Color variables
      root.style.setProperty('--ui-accent', uiAccentColor);
      root.style.setProperty('--waveform-unplayed', settings.varWaveformUnplayed || '#929292');
      root.style.setProperty('--waveform-hover', settings.varWaveformHover || 'rgba(0, 31, 103, 0.13)');
      root.style.setProperty('--player-border-color', settings.varPlayerBorder || '#ffffff');
      
      // Title appearance variables
      root.style.setProperty('--reel-title-size', ta.fontSize || '1.3rem');
      root.style.setProperty('--reel-title-weight', ta.fontWeight || '700');
      root.style.setProperty('--reel-title-align', ta.align || 'center');
      root.style.setProperty('--reel-title-padding-bottom', paddingBottom);
      
      // Background variables
      root.style.setProperty('--background-image', backgroundImage ? `url("${backgroundImage}")` : 'none');
      root.style.setProperty('--background-color', backgroundColor);
      root.style.setProperty('--background-opacity', settings.backgroundOpacity || '1');
      root.style.setProperty('--background-blur', (settings.backgroundBlur || '2') + 'px');
      root.style.setProperty('--background-zoom', settings.backgroundZoom || '1');
      root.style.setProperty('--overlay-color', overlayColor);
      
      // Blend mode variables
      if (settings.backgroundBlendMode) {
        root.style.setProperty('--background-blend-mode', settings.backgroundBlendMode);
      }
      
      // Lottie animation color variables
      root.style.setProperty('--lottie-brightness', colorFilters.brightness);
      root.style.setProperty('--lottie-saturation', colorFilters.saturation);
      root.style.setProperty('--lottie-hue-rotation', `${colorFilters.hueRotation}deg`);
      
      // Player height settings
      const playerHeight = reelData.playerHeight || 500;
      root.style.setProperty('--player-height', `${playerHeight}px`);
      
      // Expandable mode height settings
      root.style.setProperty('--expandable-collapsed-height', `${settings.expandableCollapsedHeight || 120}px`);
      root.style.setProperty('--expandable-expanded-height', `${settings.expandableExpandedHeight || 500}px`);
      
      // ============================================
      // Apply container styles
      // ============================================
      const container = document.getElementById('embedPlayer');
      const mode = reelData.mode || 'static';
      
      // Set minimum height based on mode
      if (mode === 'expandable') {
        container.style.minHeight = `${settings.expandableCollapsedHeight || 120}px`;
      } else {
        container.style.minHeight = `${playerHeight}px`;
      }
      
      // Apply base background color (always applied)
      container.style.backgroundColor = backgroundColor;
      
      // Apply background image if present
      if (backgroundImage) {
        container.style.backgroundImage = `url("${backgroundImage}")`;
        container.style.backgroundSize = 'cover';
        container.style.backgroundPosition = 'center';
      } else {
        // Clear any previously set background image
        container.style.backgroundImage = 'none';
      }
      
      // Apply blend mode if specified
      if (settings.backgroundBlendMode) {
        container.style.mixBlendMode = settings.backgroundBlendMode;
      }
      
      // NOTE: Overlay color and blur are now handled by CSS variables
      // applied to .player-wrapper::before pseudo-element
      // This ensures consistent behavior with the preview
      // No need to create a separate overlay div
    }
    
    /* ============================================
       RENDER PLAYER HTML
       Builds complete player structure
       Matches playerApp.renderPlayer() structure exactly
       ============================================ */
    function renderPlayerHTML(reelData) {
      const container = document.getElementById('embedPlayer');
      const shouldHideTitle = !(reelData.showTitle && reelData.title && reelData.title.trim());
      const settings = reelData.settings || {};
      const mode = reelData.mode || 'static';
      
      // Apply element blend mode to wrapper if specified
      const elementBlendStyle = settings.elementBlendMode 
        ? `mix-blend-mode: ${settings.elementBlendMode};` 
        : '';
      
      // Determine player wrapper classes
      let wrapperClasses = 'player-wrapper';
      if (shouldHideTitle) wrapperClasses += ' no-title';
      if (mode === 'expandable') wrapperClasses += ' expandable-mode';
      
      // Build project title overlay HTML for expandable mode
      let projectTitleOverlayHTML = '';
      if (mode === 'expandable' && settings.projectTitleImage) {
        projectTitleOverlayHTML = `
          <div class="project-title-overlay" style="background-image: url('${settings.projectTitleImage}');" data-image-url="${settings.projectTitleImage}"></div>
        `;
      }
      
      // Build complete player HTML structure
      // IMPORTANT: Must match playerApp.renderPlayer() structure exactly
      const playerHTML = `
        <div class="${wrapperClasses}" style="position: relative; z-index: 2; ${elementBlendStyle}">
          <!-- Background layers for track-specific images -->
          <div class="track-background-layer track-bg-layer-a"></div>
          <div class="track-background-layer track-bg-layer-b"></div>
          
          <!-- Video background layers (dual-buffer for crossfade) -->
          <video class="background-video main-video-a" muted loop playsinline></video>
          <video class="background-video main-video-b" muted loop playsinline></video>
          <video class="background-video track-video-a" muted loop playsinline></video>
          <video class="background-video track-video-b" muted loop playsinline></video>
          
          ${projectTitleOverlayHTML}
          <div class="player-content">
            ${reelData.showTitle && reelData.title && reelData.title.trim() ? 
              `<div class="reel-title">${reelData.title}</div>` : ''}
            <div class="track-info"></div>
            <div class="player-container">
              <button id="playPause" class="icon-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="heroicon">
                  <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm14.024-.983a1.125 1.125 0 0 1 0 1.966l-5.603 3.113A1.125 1.125 0 0 1 9 15.113V8.887c0-.857.921-1.4 1.671-.983l5.603 3.113Z" clip-rule="evenodd"/>
                </svg>
              </button>
              <div class="waveform-and-volume">
                <div id="waveform">
                  <div class="hover-overlay"></div>
                  <div class="hover-time">0:00</div>
                  <div class="playhead-time">0:00</div>
                  <div id="total-time" class="total-time">0:00</div>
                </div>
                <div class="volume-control hidden">
                  <button id="volumeToggle" class="icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="heroicon">
                      <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 0 0 1.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06ZM18.584 5.106a.75.75 0 0 1 1.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 0 1-1.06-1.06 8.25 8.25 0 0 0 0-11.668.75.75 0 0 1 0-1.06Z"/>
                      <path d="M15.932 7.757a.75.75 0 0 1 1.061 0 6 6 0 0 1 0 8.486.75.75 0 0 1-1.06-1.061 4.5 4.5 0 0 0 0-6.364.75.75 0 0 1 0-1.06Z"/>
                    </svg>
                  </button>
                  <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1"/>
                </div>
              </div>
            </div>
            <div id="loading" class="loading">
              <div class="spinner"></div>
            </div>
          </div>
          <div id="playlist" class="playlist${shouldHideTitle ? ' no-title' : ''}"></div>
        </div>
      `;
      
      // Clear loading message and insert player HTML
      container.innerHTML = '';
      container.insertAdjacentHTML('beforeend', playerHTML);
    }
    
    /* ============================================
       INITIALIZE EMBED PLAYER
       Sets up playerApp with reel configuration
       Calls all necessary setup methods
       ============================================ */
    function initializeEmbedPlayer(reelData) {
      console.log('🎵 Initializing embed player with reel:', reelData.id || 'unknown');
      
      // Store reel reference with full reelData
      playerApp.reel = reelData.settings || {};
      playerApp.currentReelSettings = reelData;
      
      // Configure expandable mode state (matches main player's renderPlayer method)
      const mode = reelData.mode || 'static';
      playerApp.expandable.enabled = (mode === 'expandable');
      playerApp.expandable.isExpanded = false;
      playerApp.expandable.isPlaying = false;
      playerApp.expandable.settings = reelData; // Store full reelData for collapsePlayer access
      playerApp.expandable.showWaveformOnCollapse = reelData.settings?.showWaveformOnCollapse !== false;
      
      console.log(`✓ Mode: ${mode}${mode === 'expandable' ? ' (expandable)' : ' (static)'}`);
      
      // ============================================
      // Cache DOM elements
      // ============================================
      playerApp.elements = {};
      playerApp.cacheElements();
      
      // ============================================
      // Setup expandable mode if enabled
      // ============================================
      if (playerApp.expandable.enabled) {
        playerApp.setupExpandableModeInteractions();
        playerApp.validateProjectTitleImage();
        console.log('✓ Expandable mode interactions enabled');
      }
      
      // ============================================
      // Apply waveform customization settings
      // ============================================
      const waveformSettings = reelData.settings?.waveform || {};
      if (waveformSettings.barsEnabled) {
        const root = document.documentElement;
        root.style.setProperty('--waveform-bar-width', `${waveformSettings.barWidth || 2}px`);
        root.style.setProperty('--waveform-bar-gap', `${waveformSettings.barGap || 1}px`);
        root.style.setProperty('--waveform-bar-radius', `${waveformSettings.barRadius || 2}px`);
        root.style.setProperty('--waveform-bar-height', waveformSettings.barHeight || 1);
        console.log('✓ Custom waveform bars enabled');
      }
      
      // ============================================
      // Setup player components
      // All functionality imported from player.js module
      // ============================================
      playerApp.setupWaveSurfer();
      playerApp.setupWaveformEvents();
      playerApp.setupPlayPauseUI();
      playerApp.setupVolumeControls();
      console.log('✓ Player components initialized');
      
      // ============================================
      // Load playlist and first track
      // ============================================
      if (reelData.playlist && reelData.playlist.length) {
        playerApp.renderPlaylist(reelData.playlist);
        const firstTrack = reelData.playlist[0];
        const url = playerApp.convertDropboxLinkToDirect(firstTrack.url);
        playerApp.initializePlayer(url, firstTrack.title, 0);
        
        // Set initial track info display
        const trackInfo = playerApp.elements.trackInfo;
        if (trackInfo) {
          const fileName = firstTrack.title || 
            firstTrack.url.split('/').pop().split('?')[0]
              .replace(/[_-]/g, ' ').replace(/\.[^/.]+$/, '');
          trackInfo.textContent = fileName;
          trackInfo.classList.add('visible');
        }
        
        console.log(`✓ Loaded ${reelData.playlist.length} track(s)`);
      }
      
      // ============================================
      // Setup keyboard controls
      // ============================================
      setupKeyboardControls();
      
      // ============================================
      // Setup playback event listeners
      // ============================================
      setupPlaybackEventListeners();
      
      console.log('✅ Player initialization complete');
    }
    
    /* ============================================
       KEYBOARD CONTROLS
       Spacebar play/pause for embed
       ============================================ */
    function setupKeyboardControls() {
      document.addEventListener("keydown", (e) => {
        const active = document.activeElement;
        const isTyping = active && (
          active.tagName === "INPUT" ||
          active.tagName === "TEXTAREA" ||
          active.isContentEditable
        );
        
        if (!isTyping && (e.code === "Space" || e.key === " ")) {
          e.preventDefault();
          if (playerApp.wavesurfer && playerApp.isWaveformReady) {
            playerApp.wavesurfer.playPause();
          }
        }
      });
    }
    
    /* ============================================
       PLAYBACK EVENT LISTENERS
       Updates play/pause button icons
       ============================================ */
    function setupPlaybackEventListeners() {
      // Update to pause icon when playing
      document.addEventListener("playback:play", () => {
        const playPauseBtn = playerApp.elements.playPauseBtn;
        if (playPauseBtn) {
          playPauseBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="heroicon">
              <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12ZM9 8.25a.75.75 0 0 0-.75.75v6c0 .414.336.75.75.75h.75a.75.75 0 0 0 .75-.75V9a.75.75 0 0 0-.75-.75H9Zm5.25 0a.75.75 0 0 0-.75.75v6c0 .414.336.75.75.75H15a.75.75 0 0 0 .75-.75V9a.75.75 0 0 0-.75-.75h-.75Z" clip-rule="evenodd" />
            </svg>
          `;
        }
      });
      
      // Update to play icon when paused
      document.addEventListener("playback:pause", () => {
        const playPauseBtn = playerApp.elements.playPauseBtn;
        if (playPauseBtn) {
          playPauseBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="heroicon">
              <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm14.024-.983a1.125 1.125 0 0 1 0 1.966l-5.603 3.113A1.125 1.125 0 0 1 9 15.113V8.887c0-.857.921-1.4 1.671-.983l5.603 3.113Z" clip-rule="evenodd" />
            </svg>
          `;
        }
      });
    }
  </script>
</body>
</html>

